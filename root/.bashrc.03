## SSL -- NGINX -- PHP -- ##

source ${HOME}/.scripts/lib.sh

if [ $(tty) == /dev/tty1 ]; then
	## Self-Signed Certificate ##
		mkdir --parents /etc/ssl/${DOMAIN}/certs && mkdir --parents /etc/ssl/${DOMAIN}/private
		SSLSUBJ='/C='${CERTC}'/ST='${CERTST}'/L='${CERTL}'/O='${CERTO}'/CN=*.'${DOMAIN}
		openssl req -x509 -sha256 -nodes -days 5480 -newkey rsa:4096 -out /etc/ssl/${DOMAIN}/certs/${DOMAIN}.pem -keyout /etc/ssl/${DOMAIN}/private/${DOMAIN}.key -utf8 -subj "${SSLSUBJ}"

	## nginx Installation ##
		nginx=development
		apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C300EE8C
		curl -o /etc/apt/sources.list.d/nginx.list ${CBURL}/etc/apt/sources.list.d/nginx.list
		apt-get update
		apt-get -y install nginx

	## nginx Configuration ##
			backup /etc/nginx/nginx.conf
		curl -o /etc/nginx/nginx.conf ${CBURL}/etc/nginx/nginx.conf
		sed -i 's|{{domain}}|'${DOMAIN}'|g' /etc/nginx/nginx.conf
		# mkdir /etc/nginx/sites-enabled/localhost
		mkdir /etc/nginx/localhost-enabled
		mkdir -p /var/log/nginx/localhost

	## WWW File Structure ##
			backup /var/www/html/index.nginx-debian.html
		# curl --create-dirs -o /var/www/html/*.${DOMAIN}/index.html ${CBURL}/var/www/html/catchAll/index.html
		# sed -i 's|{{domain}}|'${DOMAIN}'|g' /var/www/html/*.${DOMAIN}/index.html
		curl --create-dirs -o /var/www/html/*/index.html ${CBURL}/var/www/html/catchAll/index.html
		sed -i 's|{{domain}}|'${DOMAIN}'|g' /var/www/html/*/index.html
		# chown -R www-data:www-data /var/www/html

	## nginx Default Site Configuration ##
		rm /etc/nginx/sites-enabled/default
			backup /etc/nginx/sites-available/default
		# curl -o /etc/nginx/sites-available/*.${DOMAIN} ${CBURL}/etc/nginx/sites-available/catchAll
		# sed -i 's|{{domain}}|'${DOMAIN}'|g' /etc/nginx/sites-available/*.${DOMAIN}
		# ln -s /etc/nginx/sites-available/*.${DOMAIN} /etc/nginx/sites-enabled/*.${DOMAIN}
		curl -o /etc/nginx/sites-available/* ${CBURL}/etc/nginx/sites-available/catchAll
		sed -i 's|{{domain}}|'${DOMAIN}'|g' /etc/nginx/sites-available/*
		ln -s /etc/nginx/sites-available/* /etc/nginx/sites-enabled/*

	## PHP-FPM Installation ##
		apt-get -y install php5-fpm
			copy /etc/php5/fpm/php.ini
		sed -i 's|.*cgi.fix_pathinfo=.*|cgi.fix_pathinfo=1|g' /etc/php5/fpm/php.ini
			backup /etc/php5/fpm/php-fpm.conf
		curl -o /etc/php5/fpm/php-fpm.conf ${CBURL}/etc/php5/fpm/php-fpm.conf
			backup /etc/php5/fpm/pool.d/www.conf
		curl --create-dirs -o /etc/php5/fpm/pool.d/localhost/phpinfo.conf ${CBURL}/etc/php5/fpm/pool.d/localhost/phpinfo.conf
		mkdir -p /var/run/php5-fpm/localhost
		
	## PHP Extensions && Composer ##
		## Base Extensions  ##
			apt-get -y install php5-intl
			apt-get -y install php5-dev
			apt-get -y install php5-curl
			apt-get -y install php5-apcu
			apt-get -y install php5-xdebug
			
		## Sec & Auth Extensions ##
			apt-get -y install php5-mcrypt
			apt-get -y install php5-gnupg
			apt-get -y install php-auth
			apt-get -y install php-openid
			apt-get -y install php5-oauth
			
		## Parsing Extensions ##
			apt-get -y install php-xml-parser
			apt-get -y install php5-xmlrpc
			apt-get -y install php5-tidy
			
		## DB Extensions ##
			apt-get -y install php5-mysqlnd
			apt-get -y install php5-pgsql
			apt-get -y install php5-mongo
			apt-get -y install php5-redis
			
		## Graphic Extensions ##
			apt-get -y install php5-gd
			apt-get -y install php5-imagick
			
		## Composer ##
			curl -sS https://getcomposer.org/installer | php
			mv composer.phar /usr/local/bin/composer
		
	## PHP Info Configuration ##
		# curl --create-dirs -o /var/www/html/php.${DOMAIN}/index.php ${CBURL}/var/www/html/php/index.php
		curl --create-dirs -o /var/www/html/localhost/phpinfo/index.php ${CBURL}/var/www/html/localhost/phpinfo/index.php
		chown -R www-data:www-data /var/www/html
		
		# curl -o /etc/nginx/sites-available/php.${DOMAIN} ${CBURL}/etc/nginx/sites-available/php
		# sed -i 's|{{domain}}|'${DOMAIN}'|g' /etc/nginx/sites-available/php.${DOMAIN}
		# sed -i 's|{{port}}|'${HTTPPORT}'|g' /etc/nginx/sites-available/php.${DOMAIN}
		# ln -s /etc/nginx/sites-available/php.${DOMAIN} /etc/nginx/sites-enabled/php.${DOMAIN}
		# curl --create-dirs -o /etc/nginx/sites-available/localhost/phpinfo ${CBURL}/etc/nginx/sites-available/localhost/phpinfo
		curl --create-dirs -o /etc/nginx/localhost-available/phpinfo ${CBURL}/etc/nginx/localhost-available/phpinfo
		# sed -i 's|{{domain}}|'${DOMAIN}'|g' /etc/nginx/sites-available/localhost/phpinfo
		sed -i 's|{{port}}|'${HTTPPORT}'|g' /etc/nginx/localhost-available/phpinfo
		# ln -s /etc/nginx/sites-available/localhost/phpinfo /etc/nginx/sites-enabled/localhost/phpinfo
		ln -s /etc/nginx/localhost-available/phpinfo /etc/nginx/localhost-enabled/phpinfo

		service php5-fpm restart && service nginx restart
fi
